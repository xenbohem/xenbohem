<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Valxentine CafÃ©</title>
<script src="https://cdn.jsdelivr.net/npm/appwrite@9.9.0/dist/appwrite.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet">

<style>
:root{
  --blush:#FFC1CC;
  --rose:#FF6B81;
  --punch:#FF3B5C;
  --soft-bg:#FFF0F5;
  --text-dark:#4B2E3E;
  --accent:#FF69B4;
  --heart-color:#FFB6C1;
}

*{box-sizing:border-box;}
body{
  margin:0;
  font-family:'Sawarabi Mincho', cursive;
  background:linear-gradient(135deg,var(--soft-bg),#ffe6f0);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  min-height:100vh;
  overflow-x:hidden;
}

#cafe-frame{
  width:90vw;
  max-width:900px;
  min-height:90vh;
  background:rgba(255,255,255,0.9);
  border-radius:20px;
  box-shadow:0 0 60px rgba(0,0,0,0.25);
  padding:20px;
  overflow-y:auto;
  position:relative;
}

#header{
  font-size:2rem;
  text-align:center;
  margin-bottom:20px;
  color:var(--rose);
  text-shadow:0 0 6px var(--punch);
}

#welcome-note{
  background:var(--blush);
  padding:12px 16px;
  border-radius:12px;
  margin-bottom:16px;
  cursor:pointer;
  transition:0.3s all;
  max-height:500px;
  overflow:hidden;
}
#welcome-note.collapsed{
  max-height:3em;
}

#daily-prompt{
  background:var(--rose);
  color:white;
  padding:10px 14px;
  border-radius:10px;
  margin-bottom:16px;
  font-size:1.1rem;
}

#posts{
  display:flex;
  flex-direction:column-reverse;
  gap:12px;
}

.post{
  background:rgba(255,255,255,0.6);
  padding:10px 14px;
  border-radius:10px;
  border-left:4px solid var(--punch);
  display:flex;
  gap:10px;
  align-items:center;
}

.post-author{
  font-weight:bold;
  color:var(--accent);
  margin-bottom:4px;
}

.post-avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid var(--punch);
}

.post-buttons{
  margin-left:auto;
  display:flex;
  gap:6px;
}

#post-input,#avatar-input{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:none;
  margin-top:8px;
}

#post-btn{
  padding:8px 14px;
  background:var(--punch);
  color:white;
  border:none;
  border-radius:10px;
  margin-top:8px;
  cursor:pointer;
}

#music-cup{
  position:fixed;
  bottom:20px;
  right:20px;
  font-size:2rem;
  cursor:pointer;
}
#music-player{
  position:fixed;
  bottom:70px;
  right:20px;
  background:rgba(255,192,203,0.9);
  padding:12px;
  border-radius:12px;
  display:none;
}

.heart{
  position:absolute;
  width:12px;
  height:12px;
  background:var(--heart-color);
  transform:rotate(45deg);
  animation:float 4s linear infinite;
  opacity:0.8;
}
.heart::after,.heart::before{
  content:'';
  position:absolute;
  width:12px;
  height:12px;
  background:var(--heart-color);
  border-radius:50%;
}
.heart::after{top:-6px; left:0;}
.heart::before{left:-6px; top:0;}
@keyframes float{
  0%{transform:translateY(0) rotate(45deg);}
  100%{transform:translateY(-200px) rotate(45deg);}
}
</style>
</head>
<body>

<div id="cafe-frame">
  <div id="header">â˜• Welcome to Valxentine CafÃ© â˜•</div>

  <div id="welcome-note" class="collapsed">
    Hello sweet visitor! ðŸ’—<br>
    Here at Valxentine CafÃ© we explore **love, gratitude, and daily joy**.<br>
    Your heart and spirit are welcome here. Tap to expand/collapse this note.
  </div>

  <div id="daily-prompt">ðŸ’Œ Today's Love Prompt: Take a moment to appreciate something beautiful in your day.</div>

  <div id="posts"></div>

  <input id="avatar-input" type="file" accept="image/*"/>
  <input id="post-input" placeholder="Share your love noteâ€¦" />
  <button id="post-btn">Post</button>
</div>

<div id="music-cup">â˜•</div>
<div id="music-player">
  <audio id="audio-player" controls src="music/track1.mp3"></audio>
</div>

<script>
// -----------------------------
// Floating hearts
// -----------------------------
function createHeart(){
  const heart = document.createElement('div');
  heart.className='heart';
  heart.style.left=Math.random()*window.innerWidth+'px';
  heart.style.animationDuration=2+Math.random()*3+'s';
  document.body.appendChild(heart);
  setTimeout(()=>heart.remove(),4000);
}
setInterval(createHeart,300);

// -----------------------------
// Welcome note collapsible
// -----------------------------
const welcomeNote = document.getElementById('welcome-note');
const firstVisit = localStorage.getItem('firstVisit');
if(!firstVisit){
  welcomeNote.classList.remove('collapsed');
  localStorage.setItem('firstVisit','seen');
}
welcomeNote.onclick = ()=>welcomeNote.classList.toggle('collapsed');

// -----------------------------
// Music cup toggle
// -----------------------------
const cup = document.getElementById('music-cup');
const player = document.getElementById('music-player');
cup.onclick = ()=>player.style.display=(player.style.display==='none'?'block':'none');

// -----------------------------
// Appwrite setup
// -----------------------------
const client = new Appwrite.Client();
client
   .setEndpoint('https://sfo.cloud.appwrite.io/v1')  
  .setProject('698453930017e185ce48'); 

const account = new Appwrite.Account(client);
const database = new Appwrite.Database(client);
const storage = new Appwrite.Storage(client);

const collectionId = 'YOUR_COLLECTION_ID'; // your jotnotes collection

let userId = '';
let avatarUrl = '';

// -----------------------------
// Create anonymous user
// -----------------------------
account.createAnonymousSession()
  .then(res => {
    console.log('Anonymous session:', res);
    userId = res.userId;
  })
  .catch(err => console.error(err));

// -----------------------------
// Load all posts
// -----------------------------
const postsContainer = document.getElementById('posts');
const postBtn = document.getElementById('post-btn');
const postInput = document.getElementById('post-input');
const avatarInput = document.getElementById('avatar-input');

async function loadPosts(){
  postsContainer.innerHTML='';
  try{
    const res = await database.listDocuments(collectionId);
    const docs = res.documents.sort((a,b)=>new Date(a.$createdAt)-new Date(b.$createdAt));
    docs.forEach(doc=>{
      const div = document.createElement('div');
      div.className='post';
      div.innerHTML = `
        <img class="post-avatar" src="${doc.avatar || 'https://via.placeholder.com/36'}">
        <div>
          <div class="post-author">${doc.author || 'Anonymous'} â€” ${new Date(doc.$createdAt).toLocaleString()}</div>
          <div>${doc.content}</div>
        </div>
        <div class="post-buttons">
          ${doc.$permissions.update.includes(userId) ? '<button class="edit-btn">Edit</button><button class="delete-btn">Delete</button>' : ''}
        </div>
      `;
      // Delete button
      const deleteBtn = div.querySelector('.delete-btn');
      if(deleteBtn){
        deleteBtn.onclick = async () => {
          await database.deleteDocument(collectionId, doc.$id);
          loadPosts();
        };
      }
      // Edit button
      const editBtn = div.querySelector('.edit-btn');
      if(editBtn){
        editBtn.onclick = async () => {
          const newContent = prompt('Edit your note:', doc.content);
          if(newContent){
            await database.updateDocument(collectionId, doc.$id, { content: newContent });
            loadPosts();
          }
        };
      }
      postsContainer.appendChild(div);
    });
  }catch(err){
    console.error('Error fetching notes:', err);
  }
}

// -----------------------------
// Upload avatar
// -----------------------------
avatarInput.onchange = async () => {
  const file = avatarInput.files[0];
  if(!file) return;
  try{
    const uploaded = await storage.createFile('avatars', file.name, file);
    avatarUrl = client.getEndpoint() + '/storage/buckets/avatars/files/' + uploaded.$id + '/view?project=' + client.project;
    console.log('Avatar uploaded:', avatarUrl);
  }catch(err){console.error(err);}
};

// -----------------------------
// Add new note
// -----------------------------
postBtn.onclick = async () => {
  const content = postInput.value.trim();
  if(!content) return;
  try{
    const doc = await database.createDocument(collectionId, {
      author: userId,
      content: content,
      avatar: avatarUrl
    }, [`user:${userId}`], [`user:${userId}`]); // update/delete permissions for creator only

    console.log('Note successfully posted!', doc);
    postInput.value='';
    loadPosts();
  }catch(err){
    console.error('Error creating note:', err);
  }
};

// Initial load
loadPosts();
</script>
</body>
</html>

